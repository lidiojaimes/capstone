---
title: "Data Exploration"
author: "Lidio Jaimes Jr"
date: "2024-10-21"
output: pdf_document
---
```{r Importing libraries}
library(tidyverse)
library(forcats)
library(table1)
```

```{r Reading in Data}
stroke_raw <- 
  readxl::read_xlsx("Capstone Combined Data Collection Sheets - Summer 2024.xlsx", 
                    skip = 1,
                    na=c("", " ", "UNK", "Unk", "NA", "na", "Na", 9999, "????")) |> 
  janitor::clean_names()
stroke <- stroke_raw[-c(1,376), ] #get rid of dictionary and black row

# E336 (patient 333) and E340 (patient 337) have full date instead of just year
stroke[stroke$id_number == 333, "year_of_birth"] = 1905 #set as 1981 instead of 1905
stroke[stroke$id_number == 337, "year_of_birth"] = 1942
stroke$date_identified = openxlsx::convertToDate(stroke$date_identified)
stroke$date_of_stroke = openxlsx::convertToDate(stroke$date_of_stroke)
stroke$expiration_date_in_hospital = openxlsx::convertToDate(stroke$expiration_date_in_hospital)
stroke$expiration_date = openxlsx::convertToDate(stroke$expiration_date)
stroke$length_of_admission_days = round(as.numeric(stroke$length_of_admission_days),0)

stroke <- 
  stroke |> 
  filter(!id_number%in%c(211, 391, 528, 529, 536, 537, 555, 558, 576, 582),
         !id_number%in%c(316,322),
         ischemic == 1) 
```

For notes: Patient 100 has a good bit of missing. Patient 469 was transferred to different hospital. Neither removed yet. Patient 532 has 43 days of admission, but not removed yet.

For paper: Patients 316 (105 days) and 322 (79 days) were removed from analyses. Their length of admission days being so large is likely due to different factors. Patients 211, 528, 529, 536, 537, 555, 558, 576, 582 were all/majority blank and removed from analyses. Patient 391 had repeat MRN and one observation was removed from analyses. Focus on ischemic, so everyone with different type of stroke was removed. Patient 361 has a decimal for length of admission days, was rounded up to 16. 

```{r Data Wrangling}
stroke$brainstem_stroke_lcation <- as.numeric(stroke$brainstem_stroke_lcation)

stroke <-
  stroke |>
  mutate(multiple_locations = ifelse(rowSums(stroke[,106:110], na.rm = TRUE) > 1, 1, 0),
         location_of_stroke = 
           case_when(
             multiple_locations==0 & brainstem_stroke_lcation == 1 ~ "brainstem",
             multiple_locations==0 & cerebellum_stroke_location == 1 ~ "cerebellum",
             multiple_locations==0 & cortical_stroke_location == 1 ~ "cortical",
             multiple_locations==0 & subcortical_stroke_location == 1 ~ "subcortical",
             multiple_locations==0 & other_stroke_location == 1 ~ "other/unknown",
             multiple_locations==1 ~ "multiple locations",
             TRUE ~ "other/unknown"),
         location_of_stroke = factor(location_of_stroke,
                                     levels = c("brainstem","cerebellum",
                                                "cortical","subcortical",
                                                "other/unknown","multiple locations"),
                                     labels = c("Brainstem","Cerebellum",
                                                "Cortical","Subcortical",
                                                "Unknown","Multiple Locations")),
         race = ifelse(race=="Other","Other","White"),
         race = case_when(
           race == "White" ~ "White",
           str_detect(patient_identification_notes, "African") ~ "Black",
           TRUE ~ "Other"),
         race = factor(race, levels = c("White", "Black", "Other")),
         age = as.numeric(age),
         admission_nihss = as.numeric(admission_nihss),
         cholesterol_mg_d_l = as.numeric(cholesterol_mg_d_l),
         prior_stroke = case_when(
           prior_stroke == 0 ~ "No",
           prior_stroke == 1 ~ "Yes"),
         prior_tia = case_when(
           prior_tia == 0 ~ "No",
           prior_tia == 1 ~ "Yes"),
         cholesterol_group = case_when(
           cholesterol_mg_d_l < 200 ~ "Normal",
           cholesterol_mg_d_l >= 200 & cholesterol_mg_d_l <=239 ~ "Borderline high",
           cholesterol_mg_d_l >= 240 ~ "High"),
         cholesterol_group = factor(cholesterol_group,
                                    levels = c("Normal","Borderline high","High")),
         cigarette_smoking = case_when(
           cigarette_smoking == "Former" | cigarette_smoking == "former" ~ "Former",
           cigarette_smoking == "Never" | cigarette_smoking == "NEver" ~ "Never",
           cigarette_smoking == "Current" | cigarette_smoking == "Current\r\n\rCurrent" ~ "Current"),
         cigarette_smoking = factor(cigarette_smoking,
                                    levels = c("Never","Former","Current")),
         ischemic_heart_disease = ifelse(ischemic_heart_disease == 0, "No", "Yes"),
         date_cov19 = ifelse(date_of_stroke>="2020-03-15","after covid","before covid"),
         covid_19 = ifelse(date_cov19=="before covid","No",covid_19),
         covid_19 = case_when(
           covid_19 == "No" ~ "No",
           covid_19 == "Yes (Once)" ~ "Yes",
           covid_19 == "positive" ~ "Yes",
           covid_19 == "negative" ~ "No"),
         dm = factor(dm,levels=c(0,1),labels=c("No","Yes")),
         depression = factor(depression,levels=c(0,1),labels=c("No","Yes")),
         length_of_admission_days = as.numeric(length_of_admission_days),
         caregiver = case_when(
           presence_of_caregiver == "0" ~ "Absent",
           presence_of_caregiver == "1" ~ "Present",
           TRUE ~ "Unknown"),
         caregiver = factor(caregiver),
         admission_mrs_score = as.numeric(admission_mrs_score),
         pt_am_pac_score = as.numeric(pt_am_pac_score),
         discharge_nihss = as.numeric(discharge_nihss),
         discharge_mrs_score = as.numeric(discharge_mrs_score),
         ot_am_pac_score = as.numeric(ot_am_pac_score))

stroke[stroke$id_number==532,"race"] = "Other"
stroke[stroke$id_number==223,"race"] = "Other"
```

Patients with Race classified as other are either: Other(Native American and Native Hawaiian), refused to answer question, or are mixed (patient 532 and 223). No one has a stroke_location of other, people with missing data were grouped here. Some of the people with no stroke_location, have under the notes column that it is possible TIA, should these people be excluded from analysis?

Notes for paper: weird entry for presence of caregiver for 18, set as unknown.

This is about COVID-19 variable: 
```{r COVID-19}
stroke[stroke$id_number==48,"covid_19_notes"] = "2022-09-18"
stroke[stroke$id_number==139,"covid_19_notes"] = "2021-09-19"
stroke[stroke$id_number==143,"covid_19_notes"] = "2021-07-27"
stroke[stroke$id_number==168,"covid_19_notes"] = "2022-01-31"

stroke |> 
  mutate(covid_19=factor(covid_19,levels=c("Yes","No"))) |> 
  rename(`COVID-19`=covid_19) |> 
  group_by(`COVID-19`) |> 
  summarise(n())

#kableExtra::kable(ppt_tbl)
```

Patients 4, 48, 103, 139, 143, and 168 all have "Yes (Once)" for COVID-19 variable, even though they had a stroke prior to the COVID-19 date 2020-03-15. 

```{r Table 1: Patient Demographics}
label(stroke$race) <- "Race"
label(stroke$age) <- "Age"
label(stroke$sex) <- "Sex"
label(stroke$bmi_kg_m_2) <- "BMI"
label(stroke$cholesterol_mg_d_l) <- "Cholesterol"
label(stroke$admission_nihss) <- "Admission NIHSS"
label(stroke$prior_stroke) <- "Prior Stroke"
label(stroke$length_of_admission_days) <- "Length of Admission"
label(stroke$covid_19) <- "COVID-19"
label(stroke$caregiver) <- "Presence of Caregiver"


units(stroke$age) <- "years"
units(stroke$bmi_kg_m_2) <- "kg/m^2"
units(stroke$cholesterol_mg_d_l) <- "mg/dL"
units(stroke$length_of_admission_days) <- "days"

table1(~ race + age + sex + bmi_kg_m_2 + cholesterol_mg_d_l + covid_19 +
         prior_stroke + caregiver + admission_nihss + length_of_admission_days | location_of_stroke,
       overall = c(left = "Overall"),
       data = stroke)
```

```{r Figure 1: Missingness}
stroke_variables<-
  stroke |> 
  select(race,age,sex,bmi_kg_m_2,cholesterol_mg_d_l,prior_stroke,admission_nihss,covid_19)

VIM::aggr(stroke_variables,
          col = c("blue","red"),
          numbers = TRUE,
          labels = c("Race","Age","Sex","BMI","Cholesterol",
                     "Prior Stroke","Entry NIHSS","COVID-19"),
          ylab = c("Histogram of missing data", "Pattern"))
```


```{r Figure 2 : Stroke location vs NIHSS}
stroke |> 
  ggplot(aes(x=admission_nihss,y=fct_rev(location_of_stroke),fill=location_of_stroke)) + 
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Admission NIHSS") + 
  ylab("Location of Stroke")
```

Using cutoffs from JHU, hopkinsmedicine.org
```{r Figure 3: Obesity}
stroke |> 
  ggplot(aes(x = admission_nihss, y = bmi_kg_m_2, color = cholesterol_group)) +
  scale_color_manual(name = "Cholesterol Group",
                     labels = c("Normal","Boderline High","High"),
                     values = c("red","blue", "green")) + 
  geom_point() + 
  labs(x = "Admission NIHSS", y = "BMI") + 
  theme_bw() +
  geom_hline(yintercept=18.5, linetype="dashed", color = "black") +
  geom_hline(yintercept=25, linetype="dashed", color = "black")+
  theme(legend.position = "bottom")

```

```{r Figure 4: Diabetes}
stroke |> 
  group_by(location_of_stroke,dm) |> 
  summarise(median_nihss=median(admission_nihss,na.rm=TRUE)) |> 
  filter(!is.na(dm)) |> 
  ggplot(aes(x = (location_of_stroke),
             y = median_nihss,
             fill = dm)) + 
  geom_bar(stat = "identity", position = "dodge", width = 0.7, color="black") +
  scale_fill_manual(name = "Diabetic",
                     labels = c("No","Yes"),
                     values = c("red","blue")) + 
  theme_bw() +
  xlab("Location of Stroke") + 
  ylab("Median Admission NIHSS Score")
```

```{r Figure 5: location of stroke vs age}
stroke |> 
  ggplot(aes(x=age,y=fct_rev(location_of_stroke),fill=location_of_stroke)) + 
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Age") + 
  ylab("Location of Stroke")
```

```{r Figure 6: Smoking history vs NIHSS}
stroke |> 
  ggplot(aes(x=admission_nihss,y=fct_rev(cigarette_smoking),fill=cigarette_smoking)) + 
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Admission NIHSS") + 
  ylab("Smoking History")
```

```{r Figure 7: COVID}
stroke |> 
  mutate(covid_19=case_when(covid_19=="Yes"~"Yes",covid_19=="No"~"No",is.na(covid_19)~"NA"),
         covid_19=factor(covid_19)) |> 
  ggplot(aes(x=admission_nihss,y=covid_19,fill=covid_19)) + 
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Admission NIHSS") + 
  ylab("COVID-19")
```

Is the COVID variable whether they have any history or if it's present when they had stroke? maybe a mix of both? Patient 72 tested positive for COVID on 7/21/21 and their date of stroke is 11/5/20. The COVID-19 notes is that the patient expired on 7/27/21 secondary to COVID-19. The cutoff date for COVID is 3/15/20

```{r Figure 8: Heart disease vs NIHSS}
stroke |> 
  ggplot(aes(x=admission_nihss,y=fct_rev(ischemic_heart_disease),fill=ischemic_heart_disease)) + 
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Admission NIHSS") + 
  ylab("Ischemic Heart Disease History")
```

```{r Figure 9: Depression vs Length of Admission}
stroke |> select(id_number,length_of_admission_days,date_of_stroke,expiration_date_in_hospital,expiration_date)

stroke |>
  mutate(expiration = factor(expiration, levels = c(0, 1), labels = c("No", "Yes"))) |> 
  filter(expiration=="No") |> 
  ggplot(aes(x=length_of_admission_days,y=depression,fill=depression))+
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Length of Admission (days)") + 
  ylab("Depression")

stroke |>
  mutate(expiration = factor(expiration, levels = c(0, 1), labels = c("No", "Yes"))) |> 
  filter(expiration=="No") |> 
  ggplot(aes(x=length_of_admission_days,y=depression,fill=depression))+
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Length of Admission (days)") + 
  ylab("Depression")


stroke |>
  mutate(expiration = factor(expiration, levels = c(0, 1), labels = c("No", "Yes"))) |> 
  filter(length_of_admission_days<75) |> 
  ggplot(aes(x=length_of_admission_days,y=depression,fill=expiration))+
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,alpha=.2)+
  theme_bw() +
  xlab("Length of Admission (days)") + 
  ylab("Depression")

stroke |>
  filter(length_of_admission_days<75) |> 
  ggplot()+
  geom_violin(aes(x=length_of_admission_days,y=depression,fill=expiration)) + 
  geom_boxplot(aes(x=length_of_admission_days,y=depression,fill=expiration),alpha=.2)+
  theme_bw() +
  xlab("Length of Admission (days)") + 
  ylab("Depression")
```

Patient 80 has length of admission days as 3, but they died 5 days after stroke. Patient 101. **NEED** to ask about length_of_admission_days variable. 

```{r Figure 10: Depression vs NIHSS}
stroke |> 
  ggplot(aes(x=admission_nihss,y=depression,fill=depression))+
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.15,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  xlab("Admission NIHSS") + 
  ylab("Depression")
```


Need to go back in and QA this variable created.
```{r Discharge} 
discharge_info <- 
  stroke |> 
  select(id_number,expiration,acute_rehabilitation,subacute_rehabilitation,
         inpatient_rehabilitation,assited_living_facility,home_health,
         home_with_no_needs,hospice,other_discharge_location) |> 
  sapply(as.numeric) |> 
  as.data.frame()

discharge_info |> 
  mutate(sum_discharge=apply(discharge_info[3:9],1,sum)) |> 
  filter(sum_discharge==2)


stroke[, c(172,174:177,179:182)] <- lapply(stroke[, c(172,174:177,179:182)], as.numeric)

test<-
  stroke |> 
  mutate(multiple_discharge = 
           ifelse(rowSums(stroke[,c(172,174:177,179:182)], na.rm = TRUE) > 1, 1, 0),
         discharge_info = 
           case_when(
             multiple_discharge==0 & expiration == 1 ~ "Expiration",
             multiple_discharge==0 & acute_rehabilitation == 1 ~ "Acute rehabilitation",
             multiple_discharge==0 & subacute_rehabilitation == 1 ~ "Subacute rehabilitation",
             multiple_discharge==0 & inpatient_rehabilitation == 1 ~ "Inpatient rehabilitation",
             multiple_discharge==0 & assited_living_facility == 1 ~ "Assited living facility", #maybe assisted
             multiple_discharge==0 & home_health == 1 ~ "Home health",
             multiple_discharge==0 & home_with_no_needs == 1 ~ "Home with no needs",
             multiple_discharge==0 & hospice == 1 ~ "Hospice",
             multiple_discharge==0 & other_discharge_location == 1 ~ "Other discharge location",
             multiple_discharge==1 ~ "Multiple discharge",
             TRUE ~ "Unknown"),
         discharge_info = factor(discharge_info,
                                 levels = c("Expiration","Acute rehabilitation",
                                            "Subacute rehabilitation","Inpatient rehabilitation",
                                            "Assited living facility","Home health","Home with no needs",
                                            "Hospice","Other discharge location","Multiple discharge",
                                            "Unknown")))

table(test$discharge_info,useNA = "ifany")
stroke_raw |> 
  group_by(other_discharge_location) |> summarise(n())

table(stroke$expiration)
```

Everyone (9 patients) with a sum of two for discharge outcomes have home_health and hospice. Only one patient (119) has acute_rehabilitation and home_health.

For the discharge, make a case_when to include all different levels. starts at discharge (fq) to other discharge location (ga). Expiration is if they died before discharge. Check if they have a yes and a discharge location (quality conflict)

```{r}
table(is.na(stroke$pt_am_pac_score))
table(is.na(stroke$admission_mrs_score))
table(is.na(stroke$admission_nihss))

stroke |> 
  filter(is.na(pt_am_pac_score),is.na(admission_mrs_score),is.na(admission_nihss)) |>
  select(id_number,date_of_stroke)
```

look at insulin as well, medication notes

last known well time (LKWT)

```{r Score relationship}
stroke |> 
  select(admission_nihss,admission_mrs_score,pt_am_pac_score,
         discharge_nihss,discharge_mrs_score,ot_am_pac_score) |> 
  rename(admit_nihss = admission_nihss, 
         admit_mrs = admission_mrs_score,
         pt_ampac = pt_am_pac_score,
         dis_nihss = discharge_nihss,
         dis_mrs = discharge_mrs_score,
         ot_ampac = ot_am_pac_score) |> 
  #na.omit() |> # 115 patients
  GGally::ggpairs()

stroke |> 
  ggplot(aes(x=admission_nihss,y=pt_am_pac_score)) + 
  geom_point()
```


```{r Score Correlation}
stroke |> 
  select(admission_nihss,admission_mrs_score,pt_am_pac_score,
         discharge_nihss,discharge_mrs_score,ot_am_pac_score) |> 
  rename(admit_nihss = admission_nihss, 
         admit_mrs = admission_mrs_score,
         pt_ampac = pt_am_pac_score,
         dis_nihss = discharge_nihss,
         dis_mrs = discharge_mrs_score,
         ot_ampac = ot_am_pac_score) |> 
  na.omit() |> # 115 patients
  cor() |> 
  corrplot::corrplot.mixed(tl.cex=.75)

stroke |> 
  select(admission_nihss,admission_mrs_score,pt_am_pac_score) |> 
  rename(admit_nihss = admission_nihss, 
         admit_mrs = admission_mrs_score,
         pt_ampac = pt_am_pac_score) |> 
  na.omit() |> # 266 patients
  cor() |> 
  corrplot::corrplot.mixed()

stroke |> 
  select(discharge_nihss,discharge_mrs_score,ot_am_pac_score) |> 
  rename(dis_nihss = discharge_nihss,
         dis_mrs = discharge_mrs_score,
         ot_ampac = ot_am_pac_score) |> 
  na.omit() |> # 123 patients
  cor() |> 
  corrplot::corrplot.mixed()
```

