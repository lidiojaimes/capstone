---
title: "Methodology"
author: "Lidio Jaimes Jr"
date: "2025-02-21"
output: pdf_document
---
A predictive model in acute stroke patient's care incorporating pre-existing conditions (diabetes, hypertension, CAD, ischemic heart disease), lifestyle factors (smoking, obesity, hypercholesterolemia), socioeconomic, demographic factors, presence of caregiver and medication use (anticoagulants, statins, antidepressants, anxiolytics) will estimate patients' length of hospital stay at initial assessment.

$$\text{Length of admission days} = \beta_0 + \beta_1\text{AdmissionNIHSS}_i + \beta_2\text{StrokeLocation}_i + \beta_3\text{CaregiverPresence}_i + \\ \beta_4\text{PriorStroke}_i + \beta_5\text{Race}_i + \beta_6\text{Age}_i + \beta_7\text{Sex}_i + \beta_8\text{BMI}_i + \beta_{9}\text{Cholesterol}_i + \beta_{10}\text{Diabetes} + \\ + \beta_{11}\text{Statins}_i + \beta_{12}\text{Antidepressants}_i + \beta_{13}\text{Anxiolytics}_i+ \\ \beta_{14}\text{Hypertension} + \beta_{15}\text{IschemicHeartDisease} + \epsilon_i$$

$$E[\text{length of admission days}] = \beta_0 + \beta_1\text{AdmitNIHSS}_i + \beta_2\text{StrokeLocation}_i + \overrightarrow{\boldsymbol{\gamma}}^T\overrightarrow{\boldsymbol{z}_i}$$

```{r Subsetting}
mdl1_data <- 
  stroke |> 
  mutate(
    caregiver = case_when(
      caregiver == "Present" ~ 1,
      caregiver == "Absent" ~ 0),
    prior_stroke = case_when(
      prior_stroke == "No" ~ 0,
      prior_stroke == "Yes" ~ 1),
    sex_male = ifelse(sex == "Male", 1, 0),
    dm = ifelse(dm == "No", 0, 1),
    id_number = as.numeric(id_number),
    location_of_stroke = 
      factor(location_of_stroke,
             levels = c("Cortical","Multiple Locations",
                        "Subcortical","Cerebellum",
                        "Brainstem"))) |>
  filter(id_number>=375 #, #want everyone after second year of entry
         #!is.na(location_of_stroke)
         ) |> #want complete cases, no NAs location of stroke
  select(id_number,length_of_admission_days, admission_nihss, admission_mrs_score, 
         location_of_stroke, caregiver, prior_stroke, race, age, sex_male, 
         bmi_kg_m_2, cholesterol_mg_d_l, dm, antidep_arrival, anxio_arrival,
         statin_arrival, htn, ischemic_heart_disease)
```

1. Should we make an obesity indicator variable? Currently using BMI and Cholesterol. BMI has clear obesity cut off. 
2. Look at CAD and anticoagulants

```{r Completeness}
mdl1_data_complete = mdl1_data[complete.cases(mdl1_data),]

visdat::vis_miss(mdl1_data) +
  labs(title="Missingness in stroke data")
#this tells us that a lot of missing cases comes from statin variable, which was expected.

VIM::aggr(mdl1_data,
          col = c("blue","red"),
          numbers = TRUE,
          labels = names(mdl1_data),
          cex.axis=.4, gap=3,
          ylab = c("Histogram of missing data", "Pattern"))

# mdl1_data_complete_exclStatin = 
#   mdl1_data[,-16] |> na.omit()
```


```{r MICE}
library(mice)
mdl1_numeric <- mdl1_data |> select_if(is.numeric)
imputed_data <- mice(mdl1_numeric, m = 5, method = "pmm", set.seed = 123)
summary(imputed_data)

imputed_datasets <- complete(imputed_data, "all")
imputed_df <- do.call(rbind, imputed_datasets)
imputed_df$imputation <- rep(1:5, each = n)
imputed_df
mdl1_data

imputed_data <-
  mdl1_data |> 
  select_if(is.numeric) |> 
  mice(method = "norm.nob", m = 5, print = FALSE, seed = 5010)
```


```{r Full model}
mdl1 <-
  lm(length_of_admission_days ~ admission_nihss + admission_mrs_score + 
       location_of_stroke + caregiver + prior_stroke + race + sex_male + 
       bmi_kg_m_2 + cholesterol_mg_d_l + dm + antidep_arrival + anxio_arrival +
       I((age - mean(age))/10) + statin_arrival + htn + ischemic_heart_disease, 
     data = mdl1_data_complete)
summary(mdl1)
plot(mdl1)
```

```{r Robust Variance Estimator for Full model}
#Run Dan211Functions First
library(kableExtra)
full_model_table <- lmCI(mdl1, robust = TRUE)
rownames(full_model_table) <- 
  c("Intercept", "Admission NIHSS", "Admission MRS", 
    "Diff b/w Multiple locations & Cortical", 
    "Diff b/w Subcortical & Cortical",
    "Diff b/w Cerebellum & Cortical",
    "Diff b/w Brainstem & Cortical",
    "Caregiver", "Prior Stroke", "Diff b/w Black & White", 
    "Diff b/w Other & White", "Diff b/w Male & Female",
    "BMI", "Cholesterol", "Diabetes", 
    "Antidepressants at Arrival", "Anxiolytic at Arrival", 
    "Centered Age per 10 years", "Statin at Arrival", "Hypertension", 
    "Ischemic Heart Disease")
full_final_table <- kable(format_lm_output(full_model_table), file = "html",
      caption = "Stroke Model Using All Covariates and Robust Variance Estimator")
full_final_table
```

```{r Stepwise}
#step(mdl1)
mdl1_step <- 
  lm(length_of_admission_days ~ admission_nihss + admission_mrs_score + 
       race + cholesterol_mg_d_l + I((age - mean(age))/10), 
     data = mdl1_data_complete)
summary(mdl1_step)
plot(mdl1_step)
```

```{r Robust Variance Estimator for Stepwise}
#Run Dan211Functions First
library(kableExtra)
step_model_table <- lmCI(mdl1_step, robust = TRUE)
rownames(step_model_table) <- 
  c("Intercept", "Admission NIHSS", "Admission MRS", 
    "Diff b/w Black & White", "Diff b/w Other & White", 
    "Cholesterol", "Centered Age per 10 years")
step_final_table <- kable(format_lm_output(step_model_table), file = "html",
      caption = "Stroke Model Using Stepwise Covariates and Robust Variance Estimator")
step_final_table
```

Final model suggested is: 
$$\text{Length of admission days} = \beta_0 + \beta_1\text{AdmissionNIHSS} + \beta_2\text{AdmissionMRS} + \beta_3\text{Race}+ \beta_4\text{Cholesterol}+ \beta_5\text{Age/10yrs} + \epsilon$$

Will potentially use a robust variance estimator. First need to see what residual plot looks like after multiple imputation via MICE package. 

# Interaction terms

```{r Full model}
mdl1_interactions <-
  lm(length_of_admission_days ~ admission_nihss + admission_mrs_score + 
       location_of_stroke + caregiver + prior_stroke + race + sex_male + 
       bmi_kg_m_2 + cholesterol_mg_d_l + dm + antidep_arrival + anxio_arrival +
       I((age - mean(age))/10) + statin_arrival + htn + ischemic_heart_disease +
       admission_nihss:admission_mrs_score + bmi_kg_m_2:cholesterol_mg_d_l +
       admission_nihss:location_of_stroke, 
     data = mdl1_data_complete)
summary(mdl1_interactions)
plot(mdl1_interactions)
```

# Ignoring statin medication at arrival
```{r Subsetting}
mdl1_data <- 
  stroke |> 
  mutate(
    caregiver = case_when(
      caregiver == "Present" ~ 1,
      caregiver == "Absent" ~ 0),
    prior_stroke = case_when(
      prior_stroke == "No" ~ 0,
      prior_stroke == "Yes" ~ 1),
    sex_male = ifelse(sex == "Male", 1, 0),
    dm = ifelse(dm == "No", 0, 1),
    id_number = as.numeric(id_number),
    location_of_stroke = 
      factor(location_of_stroke,
             levels = c("Cortical","Multiple Locations",
                        "Subcortical","Cerebellum",
                        "Brainstem"))) |> 
  select(id_number,length_of_admission_days, admission_nihss, admission_mrs_score, 
         location_of_stroke, caregiver, prior_stroke, race, age, sex_male, 
         bmi_kg_m_2, cholesterol_mg_d_l, dm, antidep_arrival, anxio_arrival,
         htn, ischemic_heart_disease)
mdl1_data_complete = mdl1_data[complete.cases(mdl1_data),]
```

```{r Full model}
mdl1 <-
  lm(length_of_admission_days ~ admission_nihss + admission_mrs_score + 
       location_of_stroke + caregiver + prior_stroke + race + sex_male + 
       bmi_kg_m_2 + cholesterol_mg_d_l + dm + antidep_arrival + anxio_arrival +
       I((age - mean(age))/10) + htn + ischemic_heart_disease, 
     data = mdl1_data_complete)
summary(mdl1)
plot(mdl1)
```

```{r Robust Variance Estimator for Full model}
#Run Dan211Functions First
library(kableExtra)
full_model_table <- lmCI(mdl1, robust = TRUE)
rownames(full_model_table) <- 
  c("Intercept", "Admission NIHSS", "Admission MRS", 
    "Diff b/w Multiple locations & Cortical", 
    "Diff b/w Subcortical & Cortical",
    "Diff b/w Cerebellum & Cortical",
    "Diff b/w Brainstem & Cortical",
    "Caregiver", "Prior Stroke", "Diff b/w Black & White", 
    "Diff b/w Other & White", "Diff b/w Male & Female",
    "BMI", "Cholesterol", "Diabetes", 
    "Antidepressants at Arrival", "Anxiolytic at Arrival", 
    "Centered Age per 10 years", "Hypertension", 
    "Ischemic Heart Disease")
full_final_table <- kable(format_lm_output(full_model_table), file = "html",
      caption = "Stroke Model Using All Covariates and Robust Variance Estimator")
full_final_table
```

```{r Stepwise}
step(mdl1)
mdl1_step <- 
  lm(length_of_admission_days ~ admission_nihss + admission_mrs_score + 
       race + cholesterol_mg_d_l + I((age - mean(age))/10), 
     data = mdl1_data_complete)
summary(mdl1_step)
plot(mdl1_step)
```
