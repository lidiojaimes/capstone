---
title: "Data Exploration"
author: "Lidio Jaimes Jr"
date: "2024-10-21"
output: pdf_document
---
```{r Importing libraries}
library(tidyverse)
library(forcats)
library(table1)
```

```{r Reading in Data}
stroke_raw <- 
  readxl::read_xlsx("Capstone Combined Data Collection Sheets - Summer 2024.xlsx", 
                    skip = 1,
                    na=c("", " ", "UNK", "Unk", "NA", "na", "Na", 9999, "????")) |> 
  janitor::clean_names()
stroke <- stroke_raw[-c(1,376), ] #get rid of dictionary and black row

# E336 (patient 333) and E340 (patient 337) have full date instead of just year
stroke[stroke$id_number == 333, "year_of_birth"] = 1905 #set as 1981 instead of 1905
stroke[stroke$id_number == 337, "year_of_birth"] = 1942
stroke$date_identified = openxlsx::convertToDate(stroke$date_identified)
stroke$date_of_stroke = openxlsx::convertToDate(stroke$date_of_stroke)

#Patients 211, 391 (repeat MRN), 528, 529, 536, 537, 555, 558, 576, 582
stroke <- 
  stroke |> 
  filter(!id_number%in%c(211, 391, 528, 529, 536, 537, 555, 558, 576, 582),
         ischemic == 1) #focus on ischemic
#patient 100 has a good bit of missing
```

```{r Data Wrangling}
stroke$brainstem_stroke_lcation <- as.numeric(stroke$brainstem_stroke_lcation)

stroke <-
  stroke |>
  mutate(multiple_locations = ifelse(rowSums(stroke[,106:110], na.rm = TRUE) > 1, 1, 0),
         location_of_stroke = 
           case_when(
             multiple_locations==0 & brainstem_stroke_lcation == 1 ~ "brainstem",
             multiple_locations==0 & cerebellum_stroke_location == 1 ~ "cerebellum",
             multiple_locations==0 & cortical_stroke_location == 1 ~ "cortical",
             multiple_locations==0 & subcortical_stroke_location == 1 ~ "subcortical",
             multiple_locations==0 & other_stroke_location == 1 ~ "other/unknown",
             multiple_locations==1 ~ "multiple locations",
             TRUE ~ "other/unknown"),
         location_of_stroke = factor(location_of_stroke,
                                     levels = c("brainstem","cerebellum",
                                                "cortical","subcortical",
                                                "other/unknown","multiple locations"),
                                     labels = c("Brainstem","Cerebellum",
                                                "Cortical","Subcortical",
                                                "Unknown","Multiple Locations")),
         race = ifelse(race=="Other","Other","White"),
         race = case_when(
           race == "White" ~ "White",
           str_detect(patient_identification_notes, "African") ~ "Black",
           TRUE ~ "Other"),
         race = factor(race, levels = c("White", "Black", "Other")),
         age = as.numeric(age),
         admission_nihss = as.numeric(admission_nihss),
         cholesterol_mg_d_l = as.numeric(cholesterol_mg_d_l),
         prior_stroke = case_when(
           prior_stroke == 0 ~ "No",
           prior_stroke == 1 ~ "Yes"),
         prior_tia = case_when(
           prior_tia == 0 ~ "No",
           prior_tia == 1 ~ "Yes"))

stroke[stroke$id_number==532,"race"] = "Other"
stroke[stroke$id_number==223,"race"] = "Other"
```

Patients with Race classified as other are either: Other(Native American and Native Hawaiian), refused to answer question, or are mixed (patient 532). No one has a stroke_location of other, people with missing data were grouped here. Some of the people with no stroke_location, have under the notes column that it is possible TIA, should these people be excluded from analysis? 
**Need to go in and make 532 into other and 223 as native hawaiian** 223 identified as white, but also Native Hawaiian?
 

This is about COVID-19 variable: 
```{r}
table(stroke$date_of_stroke,useNA = "ifany")
stroke |> select(id_number,covid_19,covid_19_notes)


stroke |> 
  filter(date_of_stroke>="2020-03-15") |> 
  select(id_number,date_of_stroke,covid_19,covid_19_notes) |> 
  group_by(covid_19) |> 
  summarise(n())
  # arrange(date_of_stroke) |> 
  # filter(covid_19=="Yes (Once)")

stroke |> 
  mutate(date_cov19 = ifelse(date_of_stroke>="2020-03-15","after covid","before covid")) |> 
  filter(is.na(date_cov19))
```

Patients 4, 48, 103, 139, 143, and 168 all have "Yes (Once)" for COVID-19 variable, even though they had a stroke prior to the COVID-19 date 2020-03-15. Patient 48 had their stroke on 2020-02-28, so probably COVID. 

```{r Patient Demographics}
label(stroke$race) <- "Race"
label(stroke$age) <- "Age"
label(stroke$sex) <- "Sex"
label(stroke$bmi_kg_m_2) <- "BMI"
label(stroke$cholesterol_mg_d_l) <- "Cholesterol"
label(stroke$admission_nihss) <- "Admission NIHSS"
label(stroke$prior_stroke) <- "Prior Stroke"
units(stroke$age) <- "years"
units(stroke$bmi_kg_m_2) <- "kg/m^2"
units(stroke$cholesterol_mg_d_l) <- "mg/dL"

table1(~ race + age + sex + bmi_kg_m_2 + cholesterol_mg_d_l + 
         prior_stroke + admission_nihss | location_of_stroke,
       overall = c(left = "Overall"),
       data = stroke)
```

```{r Figure 2}
stroke |> 
  ggplot(aes(x=admission_nihss,y=fct_rev(location_of_stroke),fill=location_of_stroke)) + 
  geom_violin(alpha=.5) + 
  #geom_boxplot(width=.1,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  ggtitle("Stroke Severity by Lesion Location") + 
  xlab("Admission NIHSS") + 
  ylab("Location of Stroke")
```

```{r Figure 5}
stroke |> 
  ggplot(aes(x=age,y=fct_rev(location_of_stroke),fill=location_of_stroke)) + 
  geom_violin(alpha=.5) + 
  geom_boxplot(width=.3,fill="grey",alpha=.2)+
  theme_bw() +
  theme(legend.position = "none") + 
  ggtitle("Age Distribution by Stroke Location") + 
  xlab("Age") + 
  ylab("Location of Stroke")
```

